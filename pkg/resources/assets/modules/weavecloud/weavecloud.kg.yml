Variables:
  - name: flux_replicas
    type: number
    default: 1
  - name: service_token
    type: string
    optional: false

Deployments:
  - name: weave-flux-agent
    replicas: <flux_replicas>
    containers:
            - name: agent
              image: 'quay.io/weaveworks/fluxd:0.1.0'
              imagePullPolicy: IfNotPresent
              args:
                - '--token=<service_token>'

  - name: weave-scope-agent
    containers:
            - name: agent
              image: 'weaveworks/scope:latest'
              imagePullPolicy: IfNotPresent
              args:
                - '--no-app'
                - '--probe.docker.bridge=docker0'
                - '--probe.docker=true'
                - '--probe.kubernetes=true'
                - '--service-token={{.Values.ServiceToken}}'
              securityContext:
                privileged: true
              volumeMounts:
                - name: docker-socket
                  mountPath: /var/run/docker.sock
                - name: scope-plugins
                  mountPath: /var/run/scope/plugins
    volumes:
      - name: docker-socket
        hostPath:
          path: /var/run/docker.sock
      - name: scope-plugins
        hostPath:
          path: /var/run/scope/plugins
    hostPID: true
    hostNetwork: true
